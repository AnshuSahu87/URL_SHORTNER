<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URL Shortener - Analytics Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #d475c1 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    input[type="text"],
    input[type="url"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    input[type="url"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-delete {
      background: #ef4444;
      padding: 8px 16px;
      font-size: 14px;
    }

    .btn-delete:hover {
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
    }

    .result {
      background: #f0f9ff;
      border: 2px solid #bfdbfe;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .result h3 {
      color: #1e40af;
      margin-bottom: 10px;
    }

    .short-url {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .short-url input {
      flex: 1;
      background: white;
    }

    .url-list {
      list-style: none;
    }

    .url-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .url-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .url-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .url-info {
      flex: 1;
    }

    .url-code {
      font-size: 1.2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .url-original {
      color: #6b7280;
      word-break: break-all;
      font-size: 0.9rem;
    }

    .url-stats {
      display: flex;
      gap: 30px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e5e7eb;
    }

    .stat {
      display: flex;
      flex-direction: column;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1f2937;
    }

    .analytics-container {
      margin-top: 20px;
      padding: 20px;
      background: #fefce8;
      border-radius: 8px;
    }

    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .analytics-table th,
    .analytics-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .analytics-table th {
      background: #f3f4f6;
      font-weight: 600;
      color: #374151;
    }

    .chart-container {
      margin-top: 20px;
      max-height: 300px;
    }

    .error {
      background: #fee2e2;
      border: 2px solid #fca5a5;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }

      .url-stats {
        flex-direction: column;
        gap: 15px;
      }

      .url-header {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Dynamic API URL - works in both development and production
    const API_URL = window.location.origin;

    function App() {
      const [url, setUrl] = useState('');
      const [customCode, setCustomCode] = useState('');
      const [result, setResult] = useState(null);
      const [urls, setUrls] = useState([]);
      const [selectedUrl, setSelectedUrl] = useState(null);
      const [analytics, setAnalytics] = useState(null);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [activeTab, setActiveTab] = useState('create');
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        if (activeTab === 'manage') {
          fetchUrls();
        }
      }, [activeTab]);

      useEffect(() => {
        if (selectedUrl && analytics && analytics.dailyStats) {
          renderChart();
        }
        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [analytics]);

      const fetchUrls = async () => {
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/urls`);
          const data = await response.json();
          setUrls(data);
        } catch (err) {
          setError('Failed to fetch URLs');
        } finally {
          setLoading(false);
        }
      };

      const fetchAnalytics = async (shortCode) => {
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/api/analytics/${shortCode}`);
          const data = await response.json();
          setAnalytics(data);
        } catch (err) {
          setError('Failed to fetch analytics');
        } finally {
          setLoading(false);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setResult(null);

        if (!url) {
          setError('Please enter a URL');
          return;
        }

        setLoading(true);

        try {
          const response = await fetch(`${API_URL}/api/shorten`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url, customCode: customCode || undefined }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to shorten URL');
          }

          setResult(data);
          setUrl('');
          setCustomCode('');
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (shortCode) => {
        if (!confirm('Are you sure you want to delete this URL?')) {
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/urls/${shortCode}`, {
            method: 'DELETE',
          });

          if (!response.ok) {
            throw new Error('Failed to delete URL');
          }

          fetchUrls();
          if (selectedUrl === shortCode) {
            setSelectedUrl(null);
            setAnalytics(null);
          }
        } catch (err) {
          setError(err.message);
        }
      };

      const handleViewAnalytics = (shortCode) => {
        if (selectedUrl === shortCode) {
          setSelectedUrl(null);
          setAnalytics(null);
        } else {
          setSelectedUrl(shortCode);
          fetchAnalytics(shortCode);
        }
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        alert('Copied to clipboard!');
      };

      const renderChart = () => {
        if (chartInstance.current) {
          chartInstance.current.destroy();
        }

        const ctx = chartRef.current?.getContext('2d');
        if (!ctx || !analytics.dailyStats.length) return;

        const labels = analytics.dailyStats.map(stat => stat.date).reverse();
        const data = analytics.dailyStats.map(stat => stat.clicks).reverse();

        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Clicks per Day',
              data: data,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4,
              fill: true,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      };

      return (
        <div className="container">
          <div className="header">
            <h1>ðŸ”— URL Shortener</h1>
            <p>Shorten links and track analytics in real-time</p>
          </div>

          <div className="tabs">
            <button 
              className={`tab ${activeTab === 'create' ? 'active' : ''}`}
              onClick={() => setActiveTab('create')}
            >
              Create Short URL
            </button>
            <button 
              className={`tab ${activeTab === 'manage' ? 'active' : ''}`}
              onClick={() => setActiveTab('manage')}
            >
              Manage URLs
            </button>
          </div>

          {error && <div className="error">{error}</div>}

          {activeTab === 'create' && (
            <div className="card">
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label htmlFor="url">Original URL</label>
                  <input
                    type="url"
                    id="url"
                    placeholder="https://example.com/your-long-url"
                    value={url}
                    onChange={(e) => setUrl(e.target.value)}
                    required
                  />
                </div>

                <div className="form-group">
                  <label htmlFor="customCode">Custom Short Code (Optional)</label>
                  <input
                    type="text"
                    id="customCode"
                    placeholder="my-custom-code"
                    value={customCode}
                    onChange={(e) => setCustomCode(e.target.value)}
                  />
                </div>

                <button type="submit" className="btn" disabled={loading}>
                  {loading ? 'Creating...' : 'Shorten URL'}
                </button>
              </form>

              {result && (
                <div className="result">
                  <h3>âœ… URL Shortened Successfully!</h3>
                  <div className="short-url">
                    <input
                      type="text"
                      value={result.shortUrl}
                      readOnly
                    />
                    <button 
                      className="btn" 
                      onClick={() => copyToClipboard(result.shortUrl)}
                    >
                      Copy
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'manage' && (
            <div className="card">
              <h2 style={{ marginBottom: '20px' }}>Your Shortened URLs</h2>
              
              {loading && urls.length === 0 && (
                <div className="loading">Loading URLs...</div>
              )}

              {!loading && urls.length === 0 && (
                <p style={{ textAlign: 'center', color: '#6b7280', padding: '40px' }}>
                  No URLs yet. Create your first one!
                </p>
              )}

              <ul className="url-list">
                {urls.map((urlItem) => (
                  <li key={urlItem.id} className="url-item">
                    <div className="url-header">
                      <div className="url-info">
                        <div className="url-code">/{urlItem.short_code}</div>
                        <div className="url-original">{urlItem.original_url}</div>
                      </div>
                      <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                          className="btn" 
                          onClick={() => handleViewAnalytics(urlItem.short_code)}
                        >
                          {selectedUrl === urlItem.short_code ? 'Hide' : 'View'} Analytics
                        </button>
                        <button 
                          className="btn btn-delete" 
                          onClick={() => handleDelete(urlItem.short_code)}
                        >
                          Delete
                        </button>
                      </div>
                    </div>

                    <div className="url-stats">
                      <div className="stat">
                        <span className="stat-label">Total Clicks</span>
                        <span className="stat-value">{urlItem.total_clicks}</span>
                      </div>
                      <div className="stat">
                        <span className="stat-label">Created</span>
                        <span className="stat-value">
                          {new Date(urlItem.created_at).toLocaleDateString()}
                        </span>
                      </div>
                      <div className="stat">
                        <span className="stat-label">Short URL</span>
                        <span className="stat-value" style={{ fontSize: '1rem' }}>
                          <a 
                            href={`${API_URL}/${urlItem.short_code}`} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            style={{ color: '#667eea', textDecoration: 'none' }}
                          >
                            {window.location.origin}/{urlItem.short_code}
                          </a>
                        </span>
                      </div>
                    </div>

                    {selectedUrl === urlItem.short_code && analytics && (
                      <div className="analytics-container">
                        <h3>ðŸ“Š Detailed Analytics</h3>
                        
                        {analytics.dailyStats.length > 0 && (
                          <div className="chart-container">
                            <canvas ref={chartRef}></canvas>
                          </div>
                        )}

                        {analytics.analytics.length > 0 ? (
                          <table className="analytics-table">
                            <thead>
                              <tr>
                                <th>Date & Time</th>
                                <th>Referer</th>
                                <th>User Agent</th>
                              </tr>
                            </thead>
                            <tbody>
                              {analytics.analytics.slice(0, 10).map((item, index) => (
                                <tr key={index}>
                                  <td>{new Date(item.clicked_at).toLocaleString()}</td>
                                  <td>{item.referer || 'Direct'}</td>
                                  <td style={{ fontSize: '0.85rem', color: '#6b7280' }}>
                                    {item.user_agent?.substring(0, 50)}...
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        ) : (
                          <p style={{ textAlign: 'center', marginTop: '20px', color: '#6b7280' }}>
                            No clicks recorded yet
                          </p>
                        )}
                      </div>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
